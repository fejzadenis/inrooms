rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      // Allow reading user documents for networking - authenticated users can read basic profile info
      allow read: if request.auth != null;
      
      // Allow users to create only their own documents
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Allow users to update their own documents or admin can update any
      // Special handling for connections array - allow updates when adding/removing connections
      allow update: if request.auth != null && (
        request.auth.uid == userId ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com' ||
        // Allow connection updates when the authenticated user is being added/removed from connections
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['connections']) &&
         request.auth.uid in request.resource.data.connections)
      );
      
      // Allow admin to delete users
      allow delete: if request.auth != null && (
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
    }
    
    // Network profiles - simplified view for networking
    match /network_profiles/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Connection requests - for managing pending connections
    match /connection_requests/{requestId} {
      allow read: if request.auth != null && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
      allow create: if request.auth != null && (
        request.resource.data.fromUserId == request.auth.uid
      );
      allow update, delete: if request.auth != null && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
    }
    
    // Messages collection - for direct messaging between users
    match /messages/{messageId} {
      function getChatParticipants(chatId) {
        return get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }

      // Allow read if user is a participant in the associated chat or admin
      allow read: if request.auth != null && (
        (resource.data.chatId != null &&
         request.auth.uid in getChatParticipants(resource.data.chatId)) ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );

      // Allow create if both sender and receiver are participants in the chat
      allow create: if request.auth != null && 
        request.resource.data.chatId != null &&
        request.resource.data.senderId != null &&
        request.resource.data.receiverId != null &&
        request.auth.uid == request.resource.data.senderId &&
        request.resource.data.senderId in getChatParticipants(request.resource.data.chatId) &&
        request.resource.data.receiverId in getChatParticipants(request.resource.data.chatId);

      // Allow update only for marking messages as read by the receiver or admin
      allow update: if request.auth != null && (
        (resource.data.chatId != null &&
         request.auth.uid in getChatParticipants(resource.data.chatId) &&
         (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']) ||
          (request.auth.uid == resource.data.senderId &&
           request.time < resource.data.timestamp + duration.value(5, 'm')))) ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
    }
    
    // Chats collection - for managing conversations between users
    match /chats/{chatId} {
      function areUsersConnected(userId1, userId2) {
        let user1Doc = get(/databases/$(database)/documents/users/$(userId1));
        let user2Doc = get(/databases/$(database)/documents/users/$(userId2));
        
        // Safely get connections arrays, defaulting to empty list if missing
        let user1Connections = user1Doc.exists && 'connections' in user1Doc.data && user1Doc.data.connections is list 
          ? user1Doc.data.connections 
          : [];
        let user2Connections = user2Doc.exists && 'connections' in user2Doc.data && user2Doc.data.connections is list 
          ? user2Doc.data.connections 
          : [];
        
        return user1Doc.exists && user2Doc.exists &&
               userId1 in user2Connections && userId2 in user1Connections;
      }

      allow read: if request.auth != null && (
        request.auth.uid in resource.data.participants ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
      
      allow create: if request.auth != null && (
        request.auth.uid in request.resource.data.participants &&
        (request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
         request.auth.token.email == 'admin@inrooms.com' ||
         (request.resource.data.participants.size() == 2 &&
          areUsersConnected(request.resource.data.participants[0], request.resource.data.participants[1])))
      );
      
      allow update: if request.auth != null && (
        request.auth.uid in resource.data.participants ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
    }

    // Notifications collection - for user notifications
    match /notifications/{notificationId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    match /achievements/{achievementId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
    }

    match /badges/{badgeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
    }
    
    // Events collection - admin can manage, users can read
    match /events/{eventId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
    }
    
    // Registrations collection - users can manage their own, admin can view all
    match /registrations/{registrationId} {
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
      allow create, update: if request.auth != null && (
        request.resource.data.userId == request.auth.uid ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
      allow delete: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
    }

    // Reminders collection - users can manage their own
    match /reminders/{reminderId} {
      allow read, write: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
      allow create: if request.auth != null && (
        request.resource.data.userId == request.auth.uid ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
    }
    
    // Demos collection - for product demos
    match /demos/{demoId} {
      allow read: if request.auth != null;
      
      // Allow create for authenticated users with proper subscription
      allow create: if request.auth != null && (
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com' ||
        (
          request.resource.data.hostId == request.auth.uid &&
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.subscription.status == 'active' ||
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
          )
        )
      );
      
      // Allow update for demo owners or admins
      allow update: if request.auth != null && (
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com' ||
        resource.data.hostId == request.auth.uid
      );
      
      // Allow delete for demo owners or admins
      allow delete: if request.auth != null && (
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com' ||
        resource.data.hostId == request.auth.uid
      );
    }
    
    // Demo registrations collection - for managing demo attendees
    match /demo_registrations/{registrationId} {
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/demos/$(resource.data.demoId)).data.hostId == request.auth.uid ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
      
      // Allow create for any authenticated user
      allow create: if request.auth != null && (
        request.resource.data.userId == request.auth.uid ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
      
      // Allow update for the registrant, demo host, or admins
      allow update: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/demos/$(resource.data.demoId)).data.hostId == request.auth.uid ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
      
      // Allow delete for the registrant, demo host, or admins
      allow delete: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/demos/$(resource.data.demoId)).data.hostId == request.auth.uid ||
        request.auth.uid == 'uJLXftk0DCYd2ujOjxX30zETSm33' ||
        request.auth.token.email == 'admin@inrooms.com'
      );
    }
  }
}