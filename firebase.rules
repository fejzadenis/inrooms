rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      // Allow reading user documents if authenticated
      allow read: if request.auth != null;
      
      // Allow users to create their own documents
      allow create: if request.auth != null;
      
      // Allow users to update their own documents
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Allow admin to read and write all user documents
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /messages/{messageId} {
      function getChatParticipants(chatId) {
        return get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }

      function isValidChatId(senderId, receiverId, chatId) {
        return chatId == [senderId, receiverId].sort().join('_');
      }

      // Allow read if user is a participant in the associated chat
      allow read: if request.auth != null && 
        resource.data.chatId != null &&
        request.auth.uid in getChatParticipants(resource.data.chatId);

      // Allow create if chat exists and the chatId is correctly formed from sender and receiver
      allow create: if request.auth != null && 
        request.resource.data.chatId != null &&
        request.resource.data.senderId != null &&
        request.resource.data.receiverId != null &&
        request.auth.uid == request.resource.data.senderId &&
        isValidChatId(
          request.resource.data.senderId,
          request.resource.data.receiverId,
          request.resource.data.chatId
        );

      // Allow update only for marking messages as read by the receiver
      allow update: if request.auth != null && 
        resource.data.chatId != null &&
        request.auth.uid in getChatParticipants(resource.data.chatId) &&
        (
          // Only allow updating read status
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']) ||
          // Or if you're the sender updating message content within a time limit
          (request.auth.uid == resource.data.senderId &&
           request.time < resource.data.timestamp + duration.value(5, 'm'))
        );
    }
    
    match /chats/{chatId} {
      allow read: if request.auth != null && (
        request.auth.uid in resource.data.participants
      );
      allow create: if request.auth != null && (
        request.auth.uid in request.resource.data.participants
      );
      allow update: if request.auth != null && (
        request.auth.uid in resource.data.participants
      );
    }

    match /achievements/{achievementId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /badges/{badgeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Add rules for other collections
    match /events/{eventId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /registrations/{registrationId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}